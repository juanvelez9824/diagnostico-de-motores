<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico Motores El√©ctricos</title>
    <link rel="manifest" href="#" id="manifest-placeholder">
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2196F3;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .status-indicator {
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .status-good {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .photo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-item {
            position: relative;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .photo-item:hover {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .photo-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .measurements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .measurement-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .measurement-card h3 {
            color: #2196F3;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .history-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
        }
        
        .history-item h4 {
            color: #2196F3;
            margin-bottom: 5px;
        }
        
        .history-item .date {
            color: #6c757d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .measurements-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .hidden {
            display: none;
        }
        
        .ai-analysis {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Diagn√≥stico de Motores El√©ctricos</h1>
            <p>An√°lisis profesional con IA integrada</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('mediciones')">üìä Mediciones</button>
            <button class="tab" onclick="switchTab('fotos')">üì∏ Fotos</button>
            <button class="tab" onclick="switchTab('analisis')">ü§ñ An√°lisis IA</button>
            <button class="tab" onclick="switchTab('historial')">üìà Historial</button>
            <button class="tab" onclick="switchTab('configuracion')">‚öôÔ∏è Config</button>
        </div>
        
        <!-- TAB MEDICIONES -->
        <div id="mediciones" class="tab-content active">
            <h2>üìä Registro de Mediciones</h2>
            
            <div class="form-group">
                <label for="motorId">ID del Motor:</label>
                <input type="text" id="motorId" placeholder="Ej: MOT-001">
            </div>
            
            <div class="measurements-grid">
                <div class="measurement-card">
                    <h3>‚ö° Voltajes (V)</h3>
                    <div class="form-row">
                        <div>
                            <label>L1-L2:</label>
                            <input type="number" id="voltageL1L2" step="0.1" placeholder="440V">
                        </div>
                        <div>
                            <label>L2-L3:</label>
                            <input type="number" id="voltageL2L3" step="0.1" placeholder="440V">
                        </div>
                        <div>
                            <label>L1-L3:</label>
                            <input type="number" id="voltageL1L3" step="0.1" placeholder="440V">
                        </div>
                    </div>
                </div>
                
                <div class="measurement-card">
                    <h3>üîå Corrientes (A)</h3>
                    <div class="form-row">
                        <div>
                            <label>L1:</label>
                            <input type="number" id="currentL1" step="0.1" placeholder="Amperios">
                        </div>
                        <div>
                            <label>L2:</label>
                            <input type="number" id="currentL2" step="0.1" placeholder="Amperios">
                        </div>
                        <div>
                            <label>L3:</label>
                            <input type="number" id="currentL3" step="0.1" placeholder="Amperios">
                        </div>
                    </div>
                </div>
                
                <div class="measurement-card">
                    <h3>üå°Ô∏è Otros Par√°metros</h3>
                    <div class="form-group">
                        <label>Temperatura (¬∞C):</label>
                        <input type="number" id="temperature" step="0.1" placeholder="¬∞C">
                    </div>
                    <div class="form-group">
                        <label>Aislamiento (MŒ©):</label>
                        <input type="number" id="insulation" step="0.1" placeholder="MegaOhmios">
                    </div>
                    <div class="form-group">
                        <label>PI (√çndice de Polarizaci√≥n):</label>
                        <input type="number" id="pi" step="0.01" placeholder="1.0 - 4.0">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="observations">Observaciones:</label>
                <textarea id="observations" rows="3" placeholder="Observaciones adicionales..."></textarea>
            </div>
            
            <button class="btn" onclick="saveMeasurement()">üíæ Guardar Medici√≥n</button>
        </div>
        
        <!-- TAB FOTOS -->
        <div id="fotos" class="tab-content">
            <h2>üì∏ Gesti√≥n de Fotos</h2>
            
            <div class="photo-container">
                <div class="photo-item" onclick="capturePhoto('motor')">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">üîß</div>
                    <p><strong>Foto del Motor</strong></p>
                    <small>Vista general del motor el√©ctrico</small>
                    <input type="file" id="photoMotor" accept="image/*" capture="environment" style="display: none">
                </div>
                
                <div class="photo-item" onclick="capturePhoto('measurements')">
                    <div style="font-size: 2.5em; margin-bottom: 10px;">üìä</div>
                    <p><strong>Foto de las Mediciones</strong></p>
                    <small>Instrumentos y lecturas tomadas</small>
                    <input type="file" id="photoMeasurements" accept="image/*" capture="environment" style="display: none">
                </div>
            </div>
            
            <div id="photoPreview"></div>
            
            <button class="btn btn-success" onclick="uploadPhotos()">‚òÅÔ∏è Subir a Google Drive</button>
        </div>
        
        <!-- TAB AN√ÅLISIS IA -->
        <div id="analisis" class="tab-content">
            <h2>ü§ñ An√°lisis con IA</h2>
            
            <div class="form-group">
                <button class="btn" onclick="analyzeWithAI()">üîç Analizar Datos con IA</button>
            </div>
            
            <div id="aiResults" class="hidden">
                <div class="ai-analysis">
                    <h3>üìã Diagn√≥stico Autom√°tico</h3>
                    <div id="aiDiagnosis">
                        <!-- Aqu√≠ se mostrar√° el an√°lisis de la IA -->
                    </div>
                </div>
                
                <div class="status-indicator" id="motorStatus">
                    <h4>Estado General del Motor</h4>
                    <p id="statusText">Esperando an√°lisis...</p>
                </div>
            </div>
            
            <div id="aiLoading" class="loading hidden">
                <div class="spinner"></div>
                <p>Analizando datos con IA...</p>
            </div>
        </div>
        
        <!-- TAB HISTORIAL -->
        <div id="historial" class="tab-content">
            <h2>üìà Historial de Mediciones</h2>
            
            <div class="form-group">
                <input type="text" id="searchHistory" placeholder="üîç Buscar por ID de motor..." onkeyup="searchHistory()">
            </div>
            
            <div id="historyList">
                <!-- Aqu√≠ se mostrar√°n las mediciones guardadas -->
            </div>
            
            <button class="btn btn-warning" onclick="exportToExcel()">üìä Exportar a Excel</button>
            <button class="btn btn-success" onclick="syncWithDrive()">‚òÅÔ∏è Sincronizar con Drive</button>
        </div>
        
        <!-- TAB CONFIGURACI√ìN -->
        <div id="configuracion" class="tab-content">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            
            <div class="form-group">
                <h3>ü§ñ Configuraci√≥n de IA</h3>
                <label>API Key de Hugging Face:</label>
                <input type="password" id="hfApiKey" placeholder="hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                <small style="display: block; margin-top: 5px; color: #666;">
                    <strong>C√≥mo obtener tu API Key GRATIS:</strong><br>
                    1. Ve a <a href="https://huggingface.co" target="_blank" style="color: #2196F3;">huggingface.co</a><br>
                    2. Crea una cuenta gratuita<br>
                    3. Ve a Settings ‚Üí Access Tokens<br>
                    4. Crea un nuevo token (READ permissions)<br>
                    5. Copia y pega aqu√≠ tu token
                </small>
                <button class="btn btn-secondary" onclick="testHuggingFaceConnection()" style="margin-top: 10px; padding: 8px 16px; font-size: 14px;">
                    üîç Probar Conexi√≥n
                </button>
                <div id="hfStatus" class="status-indicator hidden" style="margin-top: 10px;">
                    <p id="hfStatusText">No configurado</p>
                </div>
            </div>
            
            <div class="form-group">
                <h3>‚òÅÔ∏è Google Drive</h3>
                <button class="btn" onclick="connectGoogleDrive()">üîó Conectar Google Drive</button>
                <div id="driveStatus" class="status-indicator hidden">
                    <p id="driveStatusText">No conectado</p>
                </div>
            </div>
            
            <div class="form-group">
                <h3>üîî Notificaciones</h3>
                <button class="btn" onclick="enableNotifications()">üîî Activar Notificaciones</button>
            </div>
            
            <div class="form-group">
                <h3>üì± PWA</h3>
                <button class="btn btn-success" onclick="installPWA()">üì± Instalar App</button>
            </div>
            
            <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è Limpiar Todos los Datos</button>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Variables globales
        let measurements = JSON.parse(localStorage.getItem('motorMeasurements')) || [];
        let photos = {};
        let currentTab = 'mediciones';
        
        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }
        
        // Funciones de navegaci√≥n
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'historial') {
                loadHistory();
            }
        }
        
        // Funciones de medici√≥n
        function saveMeasurement() {
            const measurement = {
                id: document.getElementById('motorId').value || 'MOT-' + Date.now(),
                timestamp: new Date().toISOString(),
                voltages: {
                    l1l2: parseFloat(document.getElementById('voltageL1L2').value) || 0,
                    l2l3: parseFloat(document.getElementById('voltageL2L3').value) || 0,
                    l1l3: parseFloat(document.getElementById('voltageL1L3').value) || 0
                },
                currents: {
                    l1: parseFloat(document.getElementById('currentL1').value) || 0,
                    l2: parseFloat(document.getElementById('currentL2').value) || 0,
                    l3: parseFloat(document.getElementById('currentL3').value) || 0
                },
                temperature: parseFloat(document.getElementById('temperature').value) || 0,
                insulation: parseFloat(document.getElementById('insulation').value) || 0,
                pi: parseFloat(document.getElementById('pi').value) || 0,
                observations: document.getElementById('observations').value || '',
                photos: photos
            };
            
            measurements.push(measurement);
            localStorage.setItem('motorMeasurements', JSON.stringify(measurements));
            
            // Mostrar notificaci√≥n
            showNotification('‚úÖ Medici√≥n guardada correctamente');
            
            // Limpiar formulario
            clearForm();
        }
        
        function clearForm() {
            document.querySelectorAll('input, textarea').forEach(input => {
                if (input.type !== 'file') {
                    input.value = '';
                }
            });
            photos = {};
        }
        
        // Funciones de fotos
        function capturePhoto(type) {
            const input = document.getElementById('photo' + type.charAt(0).toUpperCase() + type.slice(1));
            input.click();
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        photos[type] = event.target.result;
                        displayPhoto(type, event.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }
        
        function displayPhoto(type, src) {
            const preview = document.getElementById('photoPreview');
            const img = document.createElement('img');
            img.src = src;
            img.style.maxWidth = '200px';
            img.style.margin = '10px';
            img.style.borderRadius = '10px';
            preview.appendChild(img);
        }
        
        // An√°lisis con IA usando Hugging Face
        async function analyzeWithAI() {
            const apiKey = document.getElementById('hfApiKey').value;
            if (!apiKey) {
                alert('Por favor, configura tu API Key de Hugging Face en la secci√≥n Configuraci√≥n');
                switchTab('configuracion');
                return;
            }
            
            const latestMeasurement = measurements[measurements.length - 1];
            if (!latestMeasurement) {
                alert('No hay mediciones para analizar. Agrega una medici√≥n primero.');
                switchTab('mediciones');
                return;
            }
            
            document.getElementById('aiLoading').classList.remove('hidden');
            document.getElementById('aiResults').classList.add('hidden');
            
            // Guardar la API key para futuras sesiones
            localStorage.setItem('hfApiKey', apiKey);
            
            try {
                // Usar diferentes modelos seg√∫n disponibilidad
                const models = [
                    'microsoft/DialoGPT-medium',
                    'google/flan-t5-base',
                    'EleutherAI/gpt-neo-2.7B',
                    'facebook/blenderbot-400M-distill'
                ];
                
                let analysisResult = null;
                let modelUsed = null;
                
                // Intentar con diferentes modelos
                for (const model of models) {
                    try {
                        analysisResult = await callHuggingFaceAPI(apiKey, model, latestMeasurement);
                        modelUsed = model;
                        break;
                    } catch (error) {
                        console.log(`Modelo ${model} no disponible, probando siguiente...`);
                        continue;
                    }
                }
                
                if (analysisResult) {
                    displayAIAnalysis(analysisResult, latestMeasurement, modelUsed);
                } else {
                    throw new Error('Ning√∫n modelo de IA est√° disponible en este momento');
                }
                
            } catch (error) {
                console.error('Error completo:', error);
                document.getElementById('aiDiagnosis').innerHTML = `
                    <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4>‚ö†Ô∏è Error de Conexi√≥n con IA</h4>
                        <p><strong>Motivo:</strong> ${error.message}</p>
                        <p><strong>Soluci√≥n:</strong> Verifica tu API Key de Hugging Face</p>
                        <small>Realizando an√°lisis t√©cnico autom√°tico...</small>
                    </div>
                `;
                performBasicAnalysis();
            } finally {
                document.getElementById('aiLoading').classList.add('hidden');
                document.getElementById('aiResults').classList.remove('hidden');
            }
        }
        
        // Funci√≥n para llamar a la API de Hugging Face
        async function callHuggingFaceAPI(apiKey, model, measurement) {
            const prompt = createDiagnosticPrompt(measurement);
            
            const response = await fetch(`https://api-inference.huggingface.co/models/${model}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    inputs: prompt,
                    parameters: {
                        max_length: 300,
                        max_new_tokens: 150,
                        temperature: 0.7,
                        top_p: 0.9,
                        do_sample: true,
                        return_full_text: false
                    },
                    options: {
                        wait_for_model: true,
                        use_cache: false
                    }
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Error ${response.status}:`, errorText);
                throw new Error(`API Error: ${response.status} - ${errorText}`);
            }
            
            const result = await response.json();
            
            // Manejar diferentes formatos de respuesta
            if (Array.isArray(result) && result.length > 0) {
                if (result[0].generated_text) {
                    return result[0].generated_text;
                } else if (result[0].translation_text) {
                    return result[0].translation_text;
                } else if (typeof result[0] === 'string') {
                    return result[0];
                }
            } else if (result.generated_text) {
                return result.generated_text;
            }
            
            throw new Error('Formato de respuesta no reconocido');
        }
        
        // Crear prompt espec√≠fico para diagn√≥stico de motores
        function createDiagnosticPrompt(measurement) {
            const avgVoltage = (measurement.voltages.l1l2 + measurement.voltages.l2l3 + measurement.voltages.l1l3) / 3;
            const avgCurrent = (measurement.currents.l1 + measurement.currents.l2 + measurement.currents.l3) / 3;
            
            return `DIAGN√ìSTICO MOTOR EL√âCTRICO TRIF√ÅSICO:
            
Motor ID: ${measurement.id}
Voltaje nominal: 440V
Voltajes medidos: L1-L2=${measurement.voltages.l1l2}V, L2-L3=${measurement.voltages.l2l3}V, L1-L3=${measurement.voltages.l1l3}V
Promedio voltaje: ${avgVoltage.toFixed(1)}V
Corrientes: L1=${measurement.currents.l1}A, L2=${measurement.currents.l2}A, L3=${measurement.currents.l3}A
Promedio corriente: ${avgCurrent.toFixed(1)}A
Temperatura: ${measurement.temperature}¬∞C
Resistencia aislamiento: ${measurement.insulation}MŒ©
√çndice polarizaci√≥n: ${measurement.pi}
Observaciones t√©cnicas: ${measurement.observations}

Por favor, analiza estos par√°metros y proporciona:
1. Estado general del motor
2. Problemas detectados
3. Recomendaciones de mantenimiento
4. Acciones correctivas necesarias

Respuesta t√©cnica profesional:`;
        }
        
        function displayAIAnalysis(result, measurement, modelUsed) {
            // Limpiar y formatear la respuesta de la IA
            let aiResponse = result;
            if (typeof result !== 'string') {
                aiResponse = JSON.stringify(result);
            }
            
            // Mejorar formato de la respuesta
            aiResponse = aiResponse
                .replace(/\\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            document.getElementById('aiDiagnosis').innerHTML = `
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h4>ü§ñ An√°lisis de Inteligencia Artificial</h4>
                    <small style="opacity: 0.8;">Modelo utilizado: ${modelUsed}</small>
                    <div style="margin: 15px 0; line-height: 1.6;">
                        ${aiResponse}
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                    <h4>üìä An√°lisis T√©cnico Autom√°tico</h4>
                    ${getBasicAnalysis(measurement)}
                </div>
                
                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-top: 15px;">
                    <h4>üìã Resumen de Par√°metros</h4>
                    ${getSummaryTable(measurement)}
                </div>
            `;
            
            updateMotorStatus(measurement);
        }
        
        // Funci√≥n para crear tabla resumen
        function getSummaryTable(measurement) {
            const avgVoltage = (measurement.voltages.l1l2 + measurement.voltages.l2l3 + measurement.voltages.l1l3) / 3;
            const avgCurrent = (measurement.currents.l1 + measurement.currents.l2 + measurement.currents.l3) / 3;
            
            const voltageImbalance = Math.max(
                Math.abs(measurement.voltages.l1l2 - avgVoltage),
                Math.abs(measurement.voltages.l2l3 - avgVoltage),
                Math.abs(measurement.voltages.l1l3 - avgVoltage)
            ) / avgVoltage * 100;
            
            const currentImbalance = Math.max(
                Math.abs(measurement.currents.l1 - avgCurrent),
                Math.abs(measurement.currents.l2 - avgCurrent),
                Math.abs(measurement.currents.l3 - avgCurrent)
            ) / avgCurrent * 100;
            
            return `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                    <div>
                        <strong>‚ö° Voltaje Promedio:</strong> ${avgVoltage.toFixed(1)}V<br>
                        <strong>üîÑ Desbalance Voltaje:</strong> ${voltageImbalance.toFixed(1)}%<br>
                        <strong>üîå Corriente Promedio:</strong> ${avgCurrent.toFixed(1)}A<br>
                        <strong>‚öñÔ∏è Desbalance Corriente:</strong> ${currentImbalance.toFixed(1)}%
                    </div>
                    <div>
                        <strong>üå°Ô∏è Temperatura:</strong> ${measurement.temperature}¬∞C<br>
                        <strong>üõ°Ô∏è Aislamiento:</strong> ${measurement.insulation}MŒ©<br>
                        <strong>üìä √çndice PI:</strong> ${measurement.pi}<br>
                        <strong>üìÖ Fecha:</strong> ${new Date(measurement.timestamp).toLocaleDateString()}
                    </div>
                </div>
            `;
        }
        
        function performBasicAnalysis() {
            const latestMeasurement = measurements[measurements.length - 1];
            document.getElementById('aiDiagnosis').innerHTML = getBasicAnalysis(latestMeasurement);
            updateMotorStatus(latestMeasurement);
        }
        
        function getBasicAnalysis(measurement) {
            let analysis = '<ul>';
            
            // An√°lisis de voltajes
            const avgVoltage = (measurement.voltages.l1l2 + measurement.voltages.l2l3 + measurement.voltages.l1l3) / 3;
            const voltageImbalance = Math.max(
                Math.abs(measurement.voltages.l1l2 - avgVoltage),
                Math.abs(measurement.voltages.l2l3 - avgVoltage),
                Math.abs(measurement.voltages.l1l3 - avgVoltage)
            ) / avgVoltage * 100;
            
            if (voltageImbalance > 5) {
                analysis += '<li>‚ö†Ô∏è <strong>Desbalance de voltaje detectado</strong> (' + voltageImbalance.toFixed(1) + '%)</li>';
            } else {
                analysis += '<li>‚úÖ Voltajes balanceados</li>';
            }
            
            // An√°lisis de corrientes
            const avgCurrent = (measurement.currents.l1 + measurement.currents.l2 + measurement.currents.l3) / 3;
            const currentImbalance = Math.max(
                Math.abs(measurement.currents.l1 - avgCurrent),
                Math.abs(measurement.currents.l2 - avgCurrent),
                Math.abs(measurement.currents.l3 - avgCurrent)
            ) / avgCurrent * 100;
            
            if (currentImbalance > 10) {
                analysis += '<li>‚ö†Ô∏è <strong>Desbalance de corriente detectado</strong> (' + currentImbalance.toFixed(1) + '%)</li>';
            } else {
                analysis += '<li>‚úÖ Corrientes balanceadas</li>';
            }
            
            // An√°lisis de temperatura
            if (measurement.temperature > 80) {
                analysis += '<li>üî• <strong>Temperatura alta</strong> (' + measurement.temperature + '¬∞C)</li>';
            } else {
                analysis += '<li>‚úÖ Temperatura normal</li>';
            }
            
            // An√°lisis de aislamiento
            if (measurement.insulation < 1) {
                analysis += '<li>‚ö†Ô∏è <strong>Resistencia de aislamiento baja</strong> (' + measurement.insulation + ' MŒ©)</li>';
            } else {
                analysis += '<li>‚úÖ Aislamiento adecuado</li>';
            }
            
            // An√°lisis de PI
            if (measurement.pi < 1.5) {
                analysis += '<li>‚ö†Ô∏è <strong>√çndice de polarizaci√≥n bajo</strong> (' + measurement.pi + ')</li>';
            } else if (measurement.pi > 4) {
                analysis += '<li>‚ö†Ô∏è <strong>√çndice de polarizaci√≥n muy alto</strong> (' + measurement.pi + ')</li>';
            } else {
                analysis += '<li>‚úÖ √çndice de polarizaci√≥n normal</li>';
            }
            
            analysis += '</ul>';
            return analysis;
        }
        
        function updateMotorStatus(measurement) {
            const statusElement = document.getElementById('motorStatus');
            const statusText = document.getElementById('statusText');
            
            // Calcular estado general basado en los par√°metros
            let issues = 0;
            
            if (measurement.temperature > 80) issues++;
            if (measurement.insulation < 1) issues++;
            if (measurement.pi < 1.5 || measurement.pi > 4) issues++;
            
            if (issues === 0) {
                statusElement.className = 'status-indicator status-good';
                statusText.textContent = 'Motor en buen estado ‚úÖ';
            } else if (issues <= 2) {
                statusElement.className = 'status-indicator status-warning';
                statusText.textContent = 'Motor requiere atenci√≥n ‚ö†Ô∏è';
            } else {
                statusElement.className = 'status-indicator status-danger';
                statusText.textContent = 'Motor requiere mantenimiento urgente ‚ùå';
            }
        }
        
        // Funciones de historial
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            measurements.slice().reverse().forEach(measurement => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <h4>${measurement.id}</h4>
                    <div class="date">${new Date(measurement.timestamp).toLocaleString()}</div>
                    <p>Temp: ${measurement.temperature}¬∞C | Aislamiento: ${measurement.insulation}MŒ© | PI: ${measurement.pi}</p>
                    <button class="btn btn-secondary" style="margin-top: 10px; padding: 5px 15px; font-size: 14px;" onclick="viewMeasurement('${measurement.timestamp}')">Ver Detalles</button>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        function searchHistory() {
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                const motorId = item.querySelector('h4').textContent.toLowerCase();
                if (motorId.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function viewMeasurement(timestamp) {
            const measurement = measurements.find(m => m.timestamp === timestamp);
            if (measurement) {
                alert(`Detalles de ${measurement.id}:\n\nVoltajes:\nL1-L2: ${measurement.voltages.l1l2}V\nL2-L3: ${measurement.voltages.l2l3}V\nL1-L3: ${measurement.voltages.l1l3}V\n\nCorrientes:\nL1: ${measurement.currents.l1}A\nL2: ${measurement.currents.l2}A\nL3: ${measurement.currents.l3}A\n\nOtros:\nTemperatura: ${measurement.temperature}¬∞C\nAislamiento: ${measurement.insulation}MŒ©\nPI: ${measurement.pi}\n\nObservaciones:\n${measurement.observations}`);
            }
        }
        
        // Funciones de exportaci√≥n
        function exportToExcel() {
            if (measurements.length === 0) {
                alert('No hay datos para exportar');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Preparar datos para Excel
            const excelData = measurements.map(m => ({
                'ID Motor': m.id,
                'Fecha': new Date(m.timestamp).toLocaleString(),
                'Voltaje L1-L2 (V)': m.voltages.l1l2,
                'Voltaje L2-L3 (V)': m.voltages.l2l3,
                'Voltaje L1-L3 (V)': m.voltages.l1l3,
                'Corriente L1 (A)': m.currents.l1,
                'Corriente L2 (A)': m.currents.l2,
                'Corriente L3 (A)': m.currents.l3,
                'Temperatura (¬∞C)': m.temperature,
                'Aislamiento (MŒ©)': m.insulation,
                '√çndice PI': m.pi,
                'Observaciones': m.observations
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'Mediciones Motores');
            
            // Descargar archivo
            XLSX.writeFile(wb, `mediciones_motores_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('üìä Archivo Excel exportado correctamente');
        }
        
        // Funciones de Google Drive (requiere implementaci√≥n con Google API)
        function connectGoogleDrive() {
            // Esta funci√≥n necesita la implementaci√≥n completa de Google Drive API
            // Por ahora, simulamos la conexi√≥n
            document.getElementById('driveStatus').classList.remove('hidden');
            document.getElementById('driveStatusText').textContent = 'Conectado a Google Drive ‚úÖ';
            document.getElementById('driveStatus').className = 'status-indicator status-good';
            
            showNotification('üîó Conectado a Google Drive (simulado)');
        }
        
        function uploadPhotos() {
            // Simulaci√≥n de subida a Google Drive
            if (Object.keys(photos).length === 0) {
                alert('No hay fotos para subir');
                return;
            }
            
            showNotification('‚òÅÔ∏è Subiendo fotos a Google Drive...');
            
            setTimeout(() => {
                showNotification('‚úÖ Fotos subidas correctamente');
            }, 2000);
        }
        
        function syncWithDrive() {
            showNotification('üîÑ Sincronizando datos con Google Drive...');
            
            setTimeout(() => {
                showNotification('‚úÖ Sincronizaci√≥n completada');
            }, 3000);
        }
        
        // Funci√≥n para probar conexi√≥n con Hugging Face
        async function testHuggingFaceConnection() {
            const apiKey = document.getElementById('hfApiKey').value;
            if (!apiKey) {
                alert('Por favor, introduce tu API Key de Hugging Face');
                return;
            }
            
            const statusDiv = document.getElementById('hfStatus');
            const statusText = document.getElementById('hfStatusText');
            
            statusDiv.classList.remove('hidden');
            statusText.textContent = 'Probando conexi√≥n...';
            statusDiv.className = 'status-indicator status-warning';
            
            try {
                // Probar con un modelo simple y r√°pido
                const response = await fetch('https://api-inference.huggingface.co/models/facebook/blenderbot-400M-distill', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inputs: 'Hello, this is a test.',
                        options: {
                            wait_for_model: true
                        }
                    })
                });
                
                if (response.ok) {
                    // Guardar la API key si la conexi√≥n es exitosa
                    localStorage.setItem('hfApiKey', apiKey);
                    statusText.textContent = '‚úÖ Conexi√≥n exitosa - API Key v√°lida';
                    statusDiv.className = 'status-indicator status-good';
                } else {
                    const errorData = await response.text();
                    console.error('Error de API:', errorData);
                    statusText.textContent = `‚ùå Error: ${response.status} - Verifica tu API Key`;
                    statusDiv.className = 'status-indicator status-danger';
                }
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                statusText.textContent = '‚ùå Error de conexi√≥n - Verifica tu internet';
                statusDiv.className = 'status-indicator status-danger';
            }
        }
        
        // Cargar API key guardada al iniciar
        function loadSavedApiKey() {
            const savedApiKey = localStorage.getItem('hfApiKey');
            if (savedApiKey) {
                document.getElementById('hfApiKey').value = savedApiKey;
                document.getElementById('hfStatus').classList.remove('hidden');
                document.getElementById('hfStatusText').textContent = '‚úÖ API Key cargada';
                document.getElementById('hfStatus').className = 'status-indicator status-good';
            }
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        showNotification('üì± App instalada correctamente');
                    }
                    deferredPrompt = null;
                });
            } else {
                alert('La app ya est√° instalada o no es compatible con PWA');
            }
        }
        
        // Notificaciones
        function enableNotifications() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('üîî Notificaciones activadas');
                    }
                });
            }
        }
        
        function showNotification(message) {
            // Mostrar notificaci√≥n en la app
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #28a745, #20c997);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Notificaci√≥n del navegador si est√° permitido
            if (Notification.permission === 'granted') {
                new Notification('Motor Diagnostic', { body: message });
            }
        }
        
        // Agregar estilos para las animaciones de notificaci√≥n
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Funci√≥n para limpiar datos
        function clearAllData() {
            if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos?')) {
                localStorage.clear();
                measurements = [];
                photos = {};
                loadHistory();
                clearForm();
                showNotification('üóëÔ∏è Todos los datos han sido eliminados');
            }
        }
        
        // Generar manifest.json din√°micamente
        function generateManifest() {
            const manifest = {
                name: "Diagn√≥stico de Motores El√©ctricos",
                short_name: "MotorDiag",
                description: "Aplicaci√≥n profesional para diagn√≥stico de motores el√©ctricos trif√°sicos",
                start_url: "/",
                display: "standalone",
                background_color: "#667eea",
                theme_color: "#2196F3",
                orientation: "portrait",
                icons: [
                    {
                        src: "data:image/svg+xml;base64," + btoa(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="#2196F3"/>
                                <text x="50" y="60" text-anchor="middle" fill="white" font-size="40">‚ö°</text>
                            </svg>
                        `),
                        sizes: "192x192",
                        type: "image/svg+xml"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').href = manifestURL;
        }
        
        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            generateManifest();
            loadHistory();
            loadSavedApiKey(); // Cargar API key guardada
            
            // Configurar la c√°mara para dispositivos m√≥viles
            if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
                console.log('C√°mara disponible');
            }
        });
        
        // Funciones PWA
        let deferredPrompt;
        
        // Service Worker registration
        const swCode = `
            const CACHE_NAME = 'motor-diagnostic-v1';
            const urlsToCache = [
                '/',
                '/index.html'
            ];
            
            self.addEventListener('install', function(event) {
                event.waitUntil(
                    caches.open(CACHE_NAME)
                        .then(function(cache) {
                            return cache.addAll(urlsToCache);
                        })
                );
            });
            
            self.addEventListener('fetch', function(event) {
                event.respondWith(
                    caches.match(event.request)
                        .then(function(response) {
                            if (response) {
                                return response;
                            }
                            return fetch(event.request);
                        })
                );
            });
        `;
        
        // Crear el service worker como blob
        const swBlob = new Blob([swCode], {type: 'application/javascript'});
        const swURL = URL.createObjectURL(swBlob);
        
        // Registrar el service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swURL);
        }
    </script>
</body>
</html>
