<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Motores</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiRGlhZ27Ds3N0aWNvIGRlIE1vdG9yZXMiLCJzaG9ydF9uYW1lIjoiTW90b3JEaWFnIiwiZGVzY3JpcHRpb24iOiJBcGxpY2FjacOzbiBwYXJhIGRpYWduw7NzdGljbyBkZSBtb3RvcmVzIGVsw6ljdHJpY29zIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxZTI5M2IiLCJ0aGVtZV9jb2xvciI6IiMzYjgyZjYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTVRJNElpQm9aV2xuYUhROUlqRXlPQ0lpSUdacGJHeDBaWEk5SW01dmJtVWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQR0pwY21Oc2JTQm1hV3hzUFNJak16SkRRekVpSUdONFBTSXhNalFpSUdONVBTSXhNelFpSUhJOUlqUXdJaUF2UGp3dlpuUjJMejQ9IiwicyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGZpbGw9IiMzMkQ3RDEiIGN4PSIxMjQiIGN5PSIxMzQiIHI9IjQwIiAvPjwvZnRnPz4=">
    <meta name="theme-color" content="#3b82f6">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3b82f6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .tab-content {
            display: none;
            background: rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #06b6d4);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .measurement-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.1));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        .photo-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px dashed rgba(255,255,255,0.2);
        }

        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .diagnosis-card {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
        }

        .status-good { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-critical { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .motor-list {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .motor-item {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .motor-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .motor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .motor-id {
            font-size: 1.2rem;
            font-weight: 600;
            color: #3b82f6;
        }

        .motor-date {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
        }

        .notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .notification {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transform: translateX(300px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .file-input {
            display: none;
        }

        .file-label {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tab {
                font-size: 12px;
                padding: 12px 8px;
            }
        }

        .ai-analysis {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="notifications" id="notifications"></div>
    
    <div class="container">
        <div class="header">
            <h1>‚ö° Diagn√≥stico de Motores</h1>
            <p>An√°lisis t√©cnico profesional con IA integrada</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('medicion')">üìä Medici√≥n</button>
            <button class="nav-tab" onclick="showTab('historial')">üìà Historial</button>
            <button class="nav-tab" onclick="showTab('sincronizar')">‚òÅÔ∏è Sincronizar</button>
            <button class="nav-tab" onclick="showTab('configuracion')">‚öôÔ∏è Config</button>
        </div>

        <!-- Tab de Medici√≥n -->
        <div id="tab-medicion" class="tab-content active">
            <h2>Nueva Medici√≥n</h2>
            
            <div class="form-group">
                <label for="motorId">ID del Motor</label>
                <input type="text" id="motorId" placeholder="Ej: MOT-001-2025" required>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ubicacion">Ubicaci√≥n</label>
                    <input type="text" id="ubicacion" placeholder="Ej: Planta 1, Sector A">
                </div>
                <div class="form-group">
                    <label for="tecnico">T√©cnico</label>
                    <input type="text" id="tecnico" placeholder="Nombre del t√©cnico">
                </div>
            </div>

            <div class="measurement-card">
                <h3>‚ö° Mediciones El√©ctricas</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="voltaje">Voltaje (V)</label>
                        <input type="number" id="voltaje" step="0.1" placeholder="220.0">
                    </div>
                    <div class="form-group">
                        <label for="corriente">Corriente (A)</label>
                        <input type="number" id="corriente" step="0.1" placeholder="15.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="temperatura">Temperatura (¬∞C)</label>
                        <input type="number" id="temperatura" step="0.1" placeholder="65.0">
                    </div>
                    <div class="form-group">
                        <label for="aislamiento">Aislamiento (MŒ©)</label>
                        <input type="number" id="aislamiento" step="0.1" placeholder="500.0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="pi">√çndice de Polarizaci√≥n (PI)</label>
                    <input type="number" id="pi" step="0.1" placeholder="2.5">
                </div>
            </div>

            <div class="form-group">
                <h3>üì∏ Fotograf√≠as</h3>
                <input type="file" id="photoInput" class="file-input" accept="image/*" multiple capture="camera">
                <label for="photoInput" class="file-label">üì∑ Tomar/Seleccionar Fotos</label>
                <div id="photoContainer" class="photo-container"></div>
            </div>

            <div class="form-group">
                <label for="observaciones">Observaciones Adicionales</label>
                <textarea id="observaciones" rows="3" placeholder="Ruidos anormales, vibraciones, etc."></textarea>
            </div>

            <button class="btn btn-primary" onclick="procesarMedicion()">ü§ñ Analizar con IA</button>
            <button class="btn btn-secondary" onclick="guardarMedicion()">üíæ Guardar Medici√≥n</button>

            <div id="aiAnalysis" class="ai-analysis" style="display: none;">
                <h3>ü§ñ An√°lisis de IA</h3>
                <div id="aiResult"></div>
            </div>

            <div id="diagnosis" class="diagnosis-card" style="display: none;">
                <h3>üìã Diagn√≥stico</h3>
                <div id="diagnosisResult"></div>
            </div>
        </div>

        <!-- Tab de Historial -->
        <div id="tab-historial" class="tab-content">
            <h2>Historial de Mediciones</h2>
            
            <div class="form-row">
                <input type="text" id="searchMotor" placeholder="üîç Buscar por ID de motor...">
                <input type="date" id="filterDate" placeholder="Filtrar por fecha">
            </div>

            <div class="chart-container">
                <p style="color: rgba(255,255,255,0.6);">üìä Gr√°fico de tendencias se mostrar√° aqu√≠</p>
            </div>

            <div id="motorList" class="motor-list">
                <!-- Los motores se cargar√°n din√°micamente -->
            </div>
        </div>

        <!-- Tab de Sincronizar -->
        <div id="tab-sincronizar" class="tab-content">
            <h2>Sincronizaci√≥n con Google Drive</h2>
            
            <div class="measurement-card">
                <h3>‚òÅÔ∏è Estado de Sincronizaci√≥n</h3>
                <p id="syncStatus">Desconectado</p>
                <button class="btn btn-primary" onclick="connectGoogleDrive()">üîó Conectar Google Drive</button>
                <button class="btn btn-secondary" onclick="syncData()">üîÑ Sincronizar Datos</button>
            </div>

            <div class="measurement-card">
                <h3>üìä Exportar a Excel</h3>
                <button class="btn btn-primary" onclick="exportToExcel()">üìã Generar Excel</button>
                <button class="btn btn-secondary" onclick="exportPDF()">üìÑ Generar PDF</button>
            </div>
        </div>

        <!-- Tab de Configuraci√≥n -->
        <div id="tab-configuracion" class="tab-content">
            <h2>Configuraci√≥n</h2>
            
            <div class="form-group">
                <h3>üîî Notificaciones</h3>
                <label>
                    <input type="checkbox" id="notifyMaintenance"> Recordatorios de mantenimiento
                </label>
                <br>
                <label>
                    <input type="checkbox" id="notifyAnomalies"> Alertas de anomal√≠as
                </label>
            </div>

            <div class="form-group">
                <h3>‚öôÔ∏è Par√°metros de An√°lisis</h3>
                <div class="form-row">
                    <div>
                        <label for="tempLimit">Temperatura l√≠mite (¬∞C)</label>
                        <input type="number" id="tempLimit" value="80">
                    </div>
                    <div>
                        <label for="isolationLimit">Aislamiento m√≠nimo (MŒ©)</label>
                        <input type="number" id="isolationLimit" value="100">
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
        </div>
    </div>

    <script>
        // Estado global de la aplicaci√≥n
        let measurements = JSON.parse(localStorage.getItem('motorMeasurements') || '[]');
        let photos = [];
        let isConnectedToDrive = false;

        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdpbnN0YWxsJywgZXZlbnQgPT4ge30pOw==');
        }

        // Funciones de navegaci√≥n por tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById('tab-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Manejo de fotograf√≠as
        document.getElementById('photoInput').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const container = document.getElementById('photoContainer');
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        photoItem.innerHTML = `
                            <img src="${e.target.result}" alt="Foto del motor">
                            <p>${file.name}</p>
                            <button class="btn btn-secondary" onclick="this.parentElement.remove()">üóëÔ∏è Eliminar</button>
                        `;
                        container.appendChild(photoItem);
                        photos.push({
                            name: file.name,
                            data: e.target.result,
                            timestamp: new Date().toISOString()
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        // An√°lisis con IA (simulado)
        async function procesarMedicion() {
            const voltaje = parseFloat(document.getElementById('voltaje').value) || 0;
            const corriente = parseFloat(document.getElementById('corriente').value) || 0;
            const temperatura = parseFloat(document.getElementById('temperatura').value) || 0;
            const aislamiento = parseFloat(document.getElementById('aislamiento').value) || 0;
            const pi = parseFloat(document.getElementById('pi').value) || 0;

            if (!voltaje || !corriente || !temperatura || !aislamiento || !pi) {
                showNotification('Por favor completa todas las mediciones', 'error');
                return;
            }

            // Mostrar an√°lisis de IA
            const aiDiv = document.getElementById('aiAnalysis');
            const resultDiv = document.getElementById('aiResult');
            
            aiDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Analizando datos con IA...';

            // Simular an√°lisis de IA
            setTimeout(() => {
                const analysis = analyzeMotorData(voltaje, corriente, temperatura, aislamiento, pi);
                resultDiv.innerHTML = analysis.aiAnalysis;
                
                // Mostrar diagn√≥stico
                const diagDiv = document.getElementById('diagnosis');
                const diagResult = document.getElementById('diagnosisResult');
                
                diagDiv.style.display = 'block';
                diagResult.innerHTML = analysis.diagnosis;
                
                showNotification('An√°lisis completado exitosamente');
            }, 2000);
        }

        // Funci√≥n de an√°lisis de datos del motor
        function analyzeMotorData(voltaje, corriente, temperatura, aislamiento, pi) {
            let status = 'good';
            let issues = [];
            let recommendations = [];

            // An√°lisis de temperatura
            if (temperatura > 80) {
                status = 'critical';
                issues.push('Temperatura excesiva');
                recommendations.push('Revisar ventilaci√≥n y carga del motor');
            } else if (temperatura > 70) {
                status = status === 'good' ? 'warning' : status;
                issues.push('Temperatura elevada');
            }

            // An√°lisis de aislamiento
            if (aislamiento < 100) {
                status = 'critical';
                issues.push('Aislamiento deficiente');
                recommendations.push('Inspeccionar bobinados y aislamientos');
            } else if (aislamiento < 500) {
                status = status === 'good' ? 'warning' : status;
                issues.push('Aislamiento bajo');
            }

            // An√°lisis de PI
            if (pi < 1.5) {
                status = 'critical';
                issues.push('√çndice de polarizaci√≥n muy bajo');
                recommendations.push('Revisar humedad en bobinados');
            } else if (pi < 2.0) {
                status = status === 'good' ? 'warning' : status;
                issues.push('√çndice de polarizaci√≥n bajo');
            }

            // An√°lisis de voltaje
            const voltajeNominal = 220; // Asumiendo 220V nominal
            const desviacionVoltaje = Math.abs(voltaje - voltajeNominal) / voltajeNominal * 100;
            
            if (desviacionVoltaje > 10) {
                status = status === 'good' ? 'warning' : status;
                issues.push('Voltaje fuera del rango nominal');
            }

            const statusText = {
                'good': 'BUENO',
                'warning': 'ATENCI√ìN',
                'critical': 'CR√çTICO'
            };

            const statusClass = {
                'good': 'status-good',
                'warning': 'status-warning',
                'critical': 'status-critical'
            };

            const aiAnalysis = `
                <h4>üìä An√°lisis Detallado</h4>
                <p><strong>Voltaje:</strong> ${voltaje}V - ${desviacionVoltaje <= 5 ? '‚úÖ Normal' : desviacionVoltaje <= 10 ? '‚ö†Ô∏è Aceptable' : '‚ùå Fuera de rango'}</p>
                <p><strong>Corriente:</strong> ${corriente}A - ${'‚úÖ Dentro del rango'}</p>
                <p><strong>Temperatura:</strong> ${temperatura}¬∞C - ${temperatura <= 70 ? '‚úÖ Normal' : temperatura <= 80 ? '‚ö†Ô∏è Elevada' : '‚ùå Excesiva'}</p>
                <p><strong>Aislamiento:</strong> ${aislamiento}MŒ© - ${aislamiento >= 500 ? '‚úÖ Excelente' : aislamiento >= 100 ? '‚ö†Ô∏è Aceptable' : '‚ùå Deficiente'}</p>
                <p><strong>√çndice PI:</strong> ${pi} - ${pi >= 2.0 ? '‚úÖ Bueno' : pi >= 1.5 ? '‚ö†Ô∏è Aceptable' : '‚ùå Bajo'}</p>
            `;

            const diagnosis = `
                <div class="status-indicator ${statusClass[status]}">Estado: ${statusText[status]}</div>
                <h4>üîç Problemas Detectados</h4>
                ${issues.length > 0 ? issues.map(issue => `<p>‚Ä¢ ${issue}</p>`).join('') : '<p>‚Ä¢ No se detectaron problemas cr√≠ticos</p>'}
                
                <h4>üí° Recomendaciones</h4>
                ${recommendations.length > 0 ? recommendations.map(rec => `<p>‚Ä¢ ${rec}</p>`).join('') : '<p>‚Ä¢ Continuar con el mantenimiento preventivo regular</p>'}
                
                <h4>üìÖ Pr√≥xima Inspecci√≥n</h4>
                <p>‚Ä¢ ${status === 'critical' ? 'Inmediata (dentro de 24 horas)' : status === 'warning' ? 'En 1 semana' : 'En 1 mes'}</p>
            `;

            return { aiAnalysis, diagnosis, status, issues, recommendations };
        }

        // Guardar medici√≥n
        function guardarMedicion() {
            const motorId = document.getElementById('motorId').value;
            const ubicacion = document.getElementById('ubicacion').value;
            const tecnico = document.getElementById('tecnico').value;
            const voltaje = parseFloat(document.getElementById('voltaje').value) || 0;
            const corriente = parseFloat(document.getElementById('corriente').value) || 0;
            const temperatura = parseFloat(document.getElementById('temperatura').value) || 0;
            const aislamiento = parseFloat(document.getElementById('aislamiento').value) || 0;
            const pi = parseFloat(document.getElementById('pi').value) || 0;
            const observaciones = document.getElementById('observaciones').value;

            if (!motorId) {
                showNotification('Por favor ingresa un ID de motor', 'error');
                return;
            }

            const analysis = analyzeMotorData(voltaje, corriente, temperatura, aislamiento, pi);

            const measurement = {
                id: Date.now().toString(),
                motorId,
                ubicacion,
                tecnico,
                fecha: new Date().toISOString(),
                mediciones: {
                    voltaje,
                    corriente,
                    temperatura,
                    aislamiento,
                    pi
                },
                observaciones,
                fotos: [...photos],
                diagnostico: analysis,
                syncStatus: 'pending'
            };

            measurements.push(measurement);
            localStorage.setItem('motorMeasurements', JSON.stringify(measurements));

            // Limpiar formulario
            limpiarFormulario();
            photos = [];

            showNotification('Medici√≥n guardada exitosamente');
            
            // Actualizar historial si est√° visible
            if (document.getElementById('tab-historial').classList.contains('active')) {
                loadMotorHistory();
            }
        }

        // Limpiar formulario
        function limpiarFormulario() {
            document.getElementById('motorId').value = '';
            document.getElementById('ubicacion').value = '';
            document.getElementById('tecnico').value = '';
            document.getElementById('voltaje').value = '';
            document.getElementById('corriente').value = '';
            document.getElementById('temperatura').value = '';
            document.getElementById('aislamiento').value = '';
            document.getElementById('pi').value = '';
            document.getElementById('observaciones').value = '';
            document.getElementById('photoContainer').innerHTML = '';
            document.getElementById('aiAnalysis').style.display = 'none';
            document.getElementById('diagnosis').style.display = 'none';
        }

        // Cargar historial de motores
        function loadMotorHistory() {
            const motorList = document.getElementById('motorList');
            const searchTerm = document.getElementById('searchMotor').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;

            let filteredMeasurements = measurements;

            // Filtrar por b√∫squeda
            if (searchTerm) {
                filteredMeasurements = filteredMeasurements.filter(m => 
                    m.motorId.toLowerCase().includes(searchTerm) ||
                    m.ubicacion.toLowerCase().includes(searchTerm)
                );
            }

            // Filtrar por fecha
            if (filterDate) {
                filteredMeasurements = filteredMeasurements.filter(m => 
                    m.fecha.startsWith(filterDate)
                );
            }

            // Ordenar por fecha descendente
            filteredMeasurements.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            motorList.innerHTML = '';

            if (filteredMeasurements.length === 0) {
                motorList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.6);">No se encontraron mediciones</p>';
                return;
            }

            filteredMeasurements.forEach(measurement => {
                const motorItem = document.createElement('div');
                motorItem.className = 'motor-item';
                motorItem.onclick = () => showMeasurementDetails(measurement);

                const fecha = new Date(measurement.fecha).toLocaleString('es-ES');
                const statusClass = {
                    'good': 'status-good',
                    'warning': 'status-warning', 
                    'critical': 'status-critical'
                }[measurement.diagnostico.status];

                const statusText = {
                    'good': 'BUENO',
                    'warning': 'ATENCI√ìN',
                    'critical': 'CR√çTICO'
                }[measurement.diagnostico.status];

                motorItem.innerHTML = `
                    <div class="motor-header">
                        <div class="motor-id">${measurement.motorId}</div>
                        <div class="motor-date">${fecha}</div>
                    </div>
                    <div class="status-indicator ${statusClass}">${statusText}</div>
                    <p><strong>Ubicaci√≥n:</strong> ${measurement.ubicacion}</p>
                    <p><strong>T√©cnico:</strong> ${measurement.tecnico}</p>
                    <p><strong>Temperatura:</strong> ${measurement.mediciones.temperatura}¬∞C</p>
                    <p><strong>Fotos:</strong> ${measurement.fotos.length}</p>
                `;

                motorList.appendChild(motorItem);
            });
        }

        // Mostrar detalles de medici√≥n
        function showMeasurementDetails(measurement) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;

            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(135deg, #1e293b, #334155);
                border-radius: 15px;
                padding: 30px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                border: 1px solid rgba(255,255,255,0.1);
            `;

            const fecha = new Date(measurement.fecha).toLocaleString('es-ES');
            const statusClass = {
                'good': 'status-good',
                'warning': 'status-warning',
                'critical': 'status-critical'
            }[measurement.diagnostico.status];

            const statusText = {
                'good': 'BUENO',
                'warning': 'ATENCI√ìN',
                'critical': 'CR√çTICO'
            }[measurement.diagnostico.status];

            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #3b82f6;">Detalles: ${measurement.motorId}</h2>
                    <button onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
                </div>
                
                <div class="status-indicator ${statusClass}" style="margin-bottom: 20px;">${statusText}</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div>
                        <h3>üìã Informaci√≥n General</h3>
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <p><strong>Ubicaci√≥n:</strong> ${measurement.ubicacion}</p>
                        <p><strong>T√©cnico:</strong> ${measurement.tecnico}</p>
                    </div>
                    <div>
                        <h3>‚ö° Mediciones</h3>
                        <p><strong>Voltaje:</strong> ${measurement.mediciones.voltaje}V</p>
                        <p><strong>Corriente:</strong> ${measurement.mediciones.corriente}A</p>
                        <p><strong>Temperatura:</strong> ${measurement.mediciones.temperatura}¬∞C</p>
                        <p><strong>Aislamiento:</strong> ${measurement.mediciones.aislamiento}MŒ©</p>
                        <p><strong>PI:</strong> ${measurement.mediciones.pi}</p>
                    </div>
                </div>
                
                ${measurement.observaciones ? `
                    <div style="margin-bottom: 20px;">
                        <h3>üìù Observaciones</h3>
                        <p>${measurement.observaciones}</p>
                    </div>
                ` : ''}
                
                ${measurement.fotos.length > 0 ? `
                    <div style="margin-bottom: 20px;">
                        <h3>üì∏ Fotograf√≠as (${measurement.fotos.length})</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            ${measurement.fotos.map(foto => `
                                <img src="${foto.data}" style="width: 100%; height: 100px; object-fit: cover; border-radius: 5px; cursor: pointer;" onclick="window.open('${foto.data}', '_blank')">
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <div>
                    <h3>üîç Diagn√≥stico IA</h3>
                    ${measurement.diagnostico.diagnosis}
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="exportSingleMeasurement('${measurement.id}')">üìã Exportar</button>
                    <button class="btn btn-secondary" onclick="deleteMeasurement('${measurement.id}'); this.closest('.modal').remove()">üóëÔ∏è Eliminar</button>
                </div>
            `;

            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // Eliminar medici√≥n
        function deleteMeasurement(id) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar esta medici√≥n?')) {
                measurements = measurements.filter(m => m.id !== id);
                localStorage.setItem('motorMeasurements', JSON.stringify(measurements));
                loadMotorHistory();
                showNotification('Medici√≥n eliminada');
            }
        }

      
        // Conectar con Google Drive (simulado)
        async function connectGoogleDrive() {
            showNotification('Conectando con Google Drive...', 'info');
            
            // Simular conexi√≥n
            setTimeout(() => {
                isConnectedToDrive = true;
                document.getElementById('syncStatus').textContent = 'Conectado ‚úÖ';
                showNotification('Conectado a Google Drive exitosamente');
            }, 2000);
        }

        // Sincronizar datos
        async function syncData() {
            if (!isConnectedToDrive) {
                showNotification('Primero conecta con Google Drive', 'error');
                return;
            }

            showNotification('Sincronizando datos...', 'info');
            
            // Simular sincronizaci√≥n
            setTimeout(() => {
                // Marcar todas las mediciones como sincronizadas
                measurements.forEach(m => m.syncStatus = 'synced');
                localStorage.setItem('motorMeasurements', JSON.stringify(measurements));
                
                showNotification(`${measurements.length} mediciones sincronizadas`);
            }, 3000);
        }

        // Exportar a Excel (simulado)
        function exportToExcel() {
            showNotification('Generando archivo Excel...', 'info');
            
            // Crear CSV como alternativa
            let csvContent = 'ID Motor,Fecha,Ubicacion,Tecnico,Voltaje,Corriente,Temperatura,Aislamiento,PI,Estado,Observaciones\n';
            
            measurements.forEach(m => {
                const fecha = new Date(m.fecha).toLocaleString('es-ES');
                const status = {
                    'good': 'BUENO',
                    'warning': 'ATENCION',
                    'critical': 'CRITICO'
                }[m.diagnostico.status];
                
                csvContent += `${m.motorId},"${fecha}","${m.ubicacion}","${m.tecnico}",${m.mediciones.voltaje},${m.mediciones.corriente},${m.mediciones.temperatura},${m.mediciones.aislamiento},${m.mediciones.pi},"${status}","${m.observaciones}"\n`;
            });
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `diagnostico_motores_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('Archivo CSV descargado');
        }

        // Exportar a PDF (simulado)
        function exportPDF() {
            showNotification('Funcionalidad de PDF en desarrollo', 'info');
        }

        // Exportar medici√≥n individual
        function exportSingleMeasurement(id) {
            const measurement = measurements.find(m => m.id === id);
            if (!measurement) return;

            const fecha = new Date(measurement.fecha).toLocaleString('es-ES');
            const status = {
                'good': 'BUENO',
                'warning': 'ATENCI√ìN',
                'critical': 'CR√çTICO'
            }[measurement.diagnostico.status];

            let csvContent = 'Campo,Valor\n';
            csvContent += `ID Motor,${measurement.motorId}\n`;
            csvContent += `Fecha,"${fecha}"\n`;
            csvContent += `Ubicaci√≥n,"${measurement.ubicacion}"\n`;
            csvContent += `T√©cnico,"${measurement.tecnico}"\n`;
            csvContent += `Voltaje,${measurement.mediciones.voltaje}V\n`;
            csvContent += `Corriente,${measurement.mediciones.corriente}A\n`;
            csvContent += `Temperatura,${measurement.mediciones.temperatura}¬∞C\n`;
            csvContent += `Aislamiento,${measurement.mediciones.aislamiento}MŒ©\n`;
            csvContent += `PI,${measurement.mediciones.pi}\n`;
            csvContent += `Estado,"${status}"\n`;
            csvContent += `Observaciones,"${measurement.observaciones}"\n`;

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${measurement.motorId}_${measurement.fecha.split('T')[0]}.csv`;
            link.click();
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            const config = {
                notifyMaintenance: document.getElementById('notifyMaintenance').checked,
                notifyAnomalies: document.getElementById('notifyAnomalies').checked,
                tempLimit: parseFloat(document.getElementById('tempLimit').value),
                isolationLimit: parseFloat(document.getElementById('isolationLimit').value)
            };
            
            localStorage.setItem('appConfig', JSON.stringify(config));
            showNotification('Configuraci√≥n guardada');
        }

        // Cargar configuraci√≥n
        function loadConfig() {
            const config = JSON.parse(localStorage.getItem('appConfig') || '{}');
            
            if (config.notifyMaintenance !== undefined) {
                document.getElementById('notifyMaintenance').checked = config.notifyMaintenance;
            }
            if (config.notifyAnomalies !== undefined) {
                document.getElementById('notifyAnomalies').checked = config.notifyAnomalies;
            }
            if (config.tempLimit) {
                document.getElementById('tempLimit').value = config.tempLimit;
            }
            if (config.isolationLimit) {
                document.getElementById('isolationLimit').value = config.isolationLimit;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            
            // Filtros de historial
            document.getElementById('searchMotor').addEventListener('input', loadMotorHistory);
            document.getElementById('filterDate').addEventListener('change', loadMotorHistory);
            
            // Solicitar permisos de notificaci√≥n
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // Interceptar navegaci√≥n para cargar historial
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('nav-tab') && e.target.textContent.includes('Historial')) {
                setTimeout(loadMotorHistory, 100);
            }
        });
    </script>
</body>
</html>
